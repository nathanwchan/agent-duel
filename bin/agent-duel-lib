#!/usr/bin/env bash
# Shared functions for agent-duel scripts

sanitize_commit_message() {
  local message="$1"
  message=${message//\"/}
  message=${message//\`/}
  if [[ -z "$message" ]]; then
    message="Update code"
  fi
  printf '%s' "$message"
}

read_commit_message() {
  local file="$1"
  local message="Update code"
  if [[ -f "$file" ]]; then
    message=$(head -n 1 "$file" | tr -d '\r')
  fi
  sanitize_commit_message "$message"
}

commit_worktree() {
  local dir="$1"
  local message="$2"
  if [[ -d "$dir" && -n "$(git -C "$dir" status --porcelain)" ]]; then
    git -C "$dir" add -A
    if ! git -C "$dir" commit -m "$message"; then
      echo "Error: failed to commit changes. Configure git user.name/user.email or commit manually in $dir." >&2
      exit 1
    fi
  fi
}

# Detect winner from a review file.
# Returns canonical "agent-duel/codex" or "agent-duel/claude" if found, empty string otherwise.
# Uses two-pass detection:
#   1. First 5 lines with "Winner:" prefix (strict)
#   2. Any line with "winner" that mentions only one branch (moderate)
# Does NOT fall back to first mention of branch name (too error-prone).
detect_winner() {
  local file="$1"
  local winner=""

  if [[ ! -f "$file" ]]; then
    return 0
  fi

  # Pass 1: Look for "Winner: <branch>" in first 5 lines (strict format)
  winner=$(awk '
    NR <= 5 {
      line = tolower($0)
      if (index(line, "winner:") && index(line, "agent-duel/codex")) { print "agent-duel/codex"; exit }
      if (index(line, "winner:") && index(line, "agent-duel/claude")) { print "agent-duel/claude"; exit }
    }
  ' "$file")

  # Pass 2: Look for "winner" with only one branch mentioned (avoids ambiguity)
  if [[ -z "$winner" ]]; then
    winner=$(awk '
      {
        line = tolower($0)
        has_winner = index(line, "winner")
        has_codex = index(line, "agent-duel/codex")
        has_claude = index(line, "agent-duel/claude")
        if (has_winner && has_codex && !has_claude) { print "agent-duel/codex"; exit }
        if (has_winner && has_claude && !has_codex) { print "agent-duel/claude"; exit }
      }
    ' "$file")
  fi

  # No final fallback - if we can't find clear winner indication, return empty
  printf '%s' "$winner"
}
