#!/usr/bin/env bash
set -euo pipefail

usage() {
  cat <<'USAGE'
Usage: agent-duel-select [--no-summary] /tmp/agent-duel/<repo>/<feature>

Select the winning branch and switch the main repo to it.
USAGE
}

no_summary=false
if [[ $# -eq 2 && "$1" == "--no-summary" ]]; then
  no_summary=true
  shift
fi

if [[ $# -ne 1 ]]; then
  usage
  exit 1
fi

input_path="$1"
if [[ -f "$input_path" ]]; then
  session_dir="$(dirname "$input_path")"
else
  session_dir="$input_path"
fi

if [[ ! -f "$session_dir/session.env" ]]; then
  echo "Error: session.env not found in $session_dir" >&2
  exit 1
fi

# shellcheck disable=SC1090
source "$session_dir/session.env"

if [[ -z "${REPO_ROOT:-}" || -z "${SESSION_NAME:-}" ]]; then
  echo "Error: invalid session.env (missing REPO_ROOT or SESSION_NAME)." >&2
  exit 1
fi

close_session() {
  if command -v tmux >/dev/null 2>&1; then
    if tmux has-session -t "$SESSION_NAME" >/dev/null 2>&1; then
      tmux kill-session -t "$SESSION_NAME" >/dev/null 2>&1 || true
    fi
  fi
}

base_branch="${BASE_BRANCH:-main}"
consensus_file="${CONSENSUS_FILE:-$session_dir/consensus.txt}"
consensus=""
if [[ -f "$consensus_file" ]]; then
  consensus=$(head -n 1 "$consensus_file" | tr -d '\r')
fi
codex_review_file="${CODEX_REVIEW:-$session_dir/codex.review.txt}"
claude_review_file="${CLAUDE_REVIEW:-$session_dir/claude.review.txt}"

detect_winner() {
  local file="$1"
  local winner=""
  if [[ ! -f "$file" ]]; then
    return 0
  fi
  winner=$(awk 'NR<=5 {line=tolower($0); if (index(line,"winner:") && index(line,"feat/codex")) {print "feat/codex"; exit} if (index(line,"winner:") && index(line,"feat/claude")) {print "feat/claude"; exit}}' "$file")
  if [[ -z "$winner" ]]; then
    winner=$(awk '{line=tolower($0); if (index(line,"winner") && index(line,"feat/codex") && !index(line,"feat/claude")) {print "feat/codex"; exit} if (index(line,"winner") && index(line,"feat/claude") && !index(line,"feat/codex")) {print "feat/claude"; exit}}' "$file")
  fi
  if [[ -z "$winner" ]]; then
    winner=$(awk '{line=tolower($0); if (index(line,"feat/codex")) {print "feat/codex"; exit} if (index(line,"feat/claude")) {print "feat/claude"; exit}}' "$file")
  fi
  printf '%s' "$winner"
}

if [[ -z "$consensus" ]]; then
  codex_winner=$(detect_winner "$codex_review_file")
  claude_winner=$(detect_winner "$claude_review_file")
  if [[ -n "$codex_winner" && "$codex_winner" == "$claude_winner" ]]; then
    consensus="$codex_winner"
  fi
fi

if ! git -C "$REPO_ROOT" rev-parse --git-dir >/dev/null 2>&1; then
  echo "Error: repo not found at $REPO_ROOT" >&2
  exit 1
fi

summary_file="$session_dir/summary.txt"
summary_file_md="$session_dir/summary.md"
selected_file="$session_dir/selected.txt"

if ! $no_summary; then
  cat <<INFO
Agent Duel Summary
==================
Session: $SESSION_NAME
Repo: $REPO_ROOT
Base branch: $base_branch
Summary: $summary_file_md
INFO

  if [[ -f "$summary_file_md" ]]; then
    echo
    cat "$summary_file_md"
    echo
  elif [[ -f "$summary_file" ]]; then
    echo
    cat "$summary_file"
    echo
  fi
fi

echo
if $no_summary; then
  echo "Select a winner below. This will switch your main repo and close the tmux session."
  echo
fi
echo "Pick a winner:"
codex_marker=""
claude_marker=""
if [[ "$consensus" == "feat/codex" ]]; then
  codex_marker=" ***"
elif [[ "$consensus" == "feat/claude" ]]; then
  claude_marker=" ***"
fi
echo "  1) Codex (feat/codex)$codex_marker"
echo "  2) Claude (feat/claude)$claude_marker"
echo "  q) Quit"

read -r choice
case "$choice" in
  1|c|C|codex|CODEX) winner_branch="feat/codex" ;;
  2|l|L|claude|CLAUDE) winner_branch="feat/claude" ;;
  q|Q) echo "Cancelled."; close_session; exit 0 ;;
  *) echo "Invalid choice."; exit 1 ;;
esac

sanitize_commit_message() {
  local message="$1"
  message=${message//\"/}
  message=${message//\`/}
  if [[ -z "$message" ]]; then
    message="Update code"
  fi
  printf '%s' "$message"
}

read_commit_message() {
  local file="$1"
  local message="Update code"
  if [[ -f "$file" ]]; then
    message=$(head -n 1 "$file" | tr -d '\r')
  fi
  sanitize_commit_message "$message"
}

commit_worktree() {
  local dir="$1"
  local message="$2"
  if [[ -d "$dir" && -n "$(git -C "$dir" status --porcelain)" ]]; then
    git -C "$dir" add -A
    if ! git -C "$dir" commit -m "$message"; then
      echo "Error: failed to commit changes. Configure git user.name/user.email or commit manually in $dir." >&2
      exit 1
    fi
  fi
}

codex_commit_message_file="${CODEX_COMMIT_MESSAGE_FILE:-$session_dir/codex.commit.txt}"
claude_commit_message_file="${CLAUDE_COMMIT_MESSAGE_FILE:-$session_dir/claude.commit.txt}"
codex_commit_message=$(read_commit_message "$codex_commit_message_file")
claude_commit_message=$(read_commit_message "$claude_commit_message_file")

if ! git -C "$REPO_ROOT" show-ref --verify --quiet "refs/heads/$winner_branch"; then
  echo "Error: branch not found: $winner_branch" >&2
  exit 1
fi

winner_dir="$CODEX_DIR"
loser_dir="$CLAUDE_DIR"
if [[ "$winner_branch" == "feat/claude" ]]; then
  winner_dir="$CLAUDE_DIR"
  loser_dir="$CODEX_DIR"
fi

commit_worktree "$CODEX_DIR" "$codex_commit_message"
commit_worktree "$CLAUDE_DIR" "$claude_commit_message"

if [[ -d "$loser_dir" ]]; then
  git -C "$REPO_ROOT" worktree remove --force "$loser_dir" >/dev/null 2>&1 || true
fi
if [[ -d "$winner_dir" ]]; then
  if ! git -C "$REPO_ROOT" worktree remove --force "$winner_dir"; then
    echo "Error: failed to remove winner worktree at $winner_dir." >&2
    exit 1
  fi
fi

git -C "$REPO_ROOT" switch "$winner_branch"

printf '%s\n' "$winner_branch" > "$selected_file"

echo "Switched to $winner_branch in $REPO_ROOT"
git -C "$REPO_ROOT" --no-pager log -1 --stat
if command -v tmux >/dev/null 2>&1; then
  if tmux has-session -t "$SESSION_NAME" 2>/dev/null; then
    echo "Closing tmux session $SESSION_NAME..."
    tmux kill-session -t "$SESSION_NAME"
  fi
fi
