#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
# shellcheck source=agent-duel-lib
source "$SCRIPT_DIR/agent-duel-lib"

usage() {
  cat <<'USAGE'
Usage: agent-duel-select [--no-summary] [--wait] /tmp/agent-duel/<repo>/<feature>

Select the winning branch and switch the main repo to it.
USAGE
}

no_summary=false
wait_for_reviews=false
while [[ $# -gt 0 ]]; do
  case "$1" in
    --no-summary) no_summary=true; shift ;;
    --wait) wait_for_reviews=true; shift ;;
    -h|--help) usage; exit 0 ;;
    --) shift; break ;;
    *) break ;;
  esac
done

if [[ $# -ne 1 ]]; then
  usage
  exit 1
fi

input_path="$1"
if [[ -f "$input_path" ]]; then
  session_dir="$(dirname "$input_path")"
else
  session_dir="$input_path"
fi

if [[ ! -f "$session_dir/session.env" ]]; then
  echo "Error: session.env not found in $session_dir" >&2
  exit 1
fi

# shellcheck disable=SC1090
source "$session_dir/session.env"

if [[ -z "${REPO_ROOT:-}" || -z "${SESSION_NAME:-}" ]]; then
  echo "Error: invalid session.env (missing REPO_ROOT or SESSION_NAME)." >&2
  exit 1
fi

close_session() {
  if command -v tmux >/dev/null 2>&1; then
    if tmux has-session -t "$SESSION_NAME" >/dev/null 2>&1; then
      tmux kill-session -t "$SESSION_NAME" >/dev/null 2>&1 || true
    fi
  fi
}

wait_for_reviews() {
  local codex_file="$1"
  local claude_file="$2"
  local spinner="|/-\\"
  local msg="Waiting for Codex and Claude to determine a winner"
  local i=0
  local min_ticks=6
  local stty_state=""
  local used_stty=false

  if [[ -t 0 ]] && command -v stty >/dev/null 2>&1; then
    stty_state=$(stty -g 2>/dev/null || true)
    if [[ -n "$stty_state" ]]; then
      stty -echo
      used_stty=true
      trap "stty '$stty_state'" EXIT
    fi
  fi

  while [[ $i -lt $min_ticks || ! -s "$codex_file" || ! -s "$claude_file" ]]; do
    local frame="${spinner:i%${#spinner}:1}"
    printf '\r[%c] %s...' "$frame" "$msg"
    i=$((i+1))
    read -r -t 0 -n 1 _ || true
    sleep 0.2
  done

  printf '\r\033[K'
  if $used_stty; then
    stty "$stty_state"
    trap - EXIT
  fi

  while read -r -t 0 -n 1 _; do :; done
  echo "Reviews received."
}

base_branch="${BASE_BRANCH:-main}"
consensus_file="${CONSENSUS_FILE:-$session_dir/consensus.txt}"
codex_review_file="${CODEX_REVIEW:-$session_dir/codex.review.txt}"
claude_review_file="${CLAUDE_REVIEW:-$session_dir/claude.review.txt}"

if $wait_for_reviews; then
  wait_for_reviews "$codex_review_file" "$claude_review_file"
fi

codex_winner=""
claude_winner=""
if [[ -f "$codex_review_file" ]]; then
  codex_winner=$(detect_winner "$codex_review_file")
fi
if [[ -f "$claude_review_file" ]]; then
  claude_winner=$(detect_winner "$claude_review_file")
fi

consensus=""
if [[ -f "$consensus_file" ]]; then
  consensus=$(head -n 1 "$consensus_file" | tr -d '\r')
fi
if [[ -z "$consensus" ]]; then
  if [[ -n "$codex_winner" && "$codex_winner" == "$claude_winner" ]]; then
    consensus="$codex_winner"
  fi
fi

bold=""
underline=""
reset=""
if [[ -t 1 ]]; then
  bold=$'\033[1m'
  underline=$'\033[4m'
  reset=$'\033[0m'
fi

if ! git -C "$REPO_ROOT" rev-parse --git-dir >/dev/null 2>&1; then
  echo "Error: repo not found at $REPO_ROOT" >&2
  exit 1
fi

summary_file="$session_dir/summary.txt"
summary_file_md="$session_dir/summary.md"
selected_file="$session_dir/selected.txt"

if ! $no_summary; then
  cat <<INFO
Agent Duel Summary
==================
Session: $SESSION_NAME
Repo: $REPO_ROOT
Base branch: $base_branch
Summary: $summary_file_md
INFO

  if [[ -f "$summary_file_md" ]]; then
    echo
    cat "$summary_file_md"
    echo
  elif [[ -f "$summary_file" ]]; then
    echo
    cat "$summary_file"
    echo
  fi
fi

echo
echo "Winner Selection"
echo "================"
if $no_summary; then
  echo "Pick a winner to apply. This will switch your main repo and close the tmux session."
else
  echo "Pick a winner to apply. This will switch your main repo."
fi
echo
printf '%s%sResult%s\n' "$bold" "$underline" "$reset"
echo "======"
if [[ -n "$consensus" ]]; then
  if [[ "$consensus" == "agent-duel/codex" ]]; then
    printf '%s%sWINNER: CODEX (agent-duel/codex)%s\n' "$bold" "$underline" "$reset"
  else
    printf '%s%sWINNER: CLAUDE (agent-duel/claude)%s\n' "$bold" "$underline" "$reset"
  fi
else
  printf '%s%sTIE: No consensus between reviews.%s\n' "$bold" "$underline" "$reset"
fi
echo
echo "Options:"
codex_marker=""
claude_marker=""
if [[ "$consensus" == "agent-duel/codex" ]]; then
  codex_marker="  <-- RECOMMENDED"
elif [[ "$consensus" == "agent-duel/claude" ]]; then
  claude_marker="  <-- RECOMMENDED"
fi
echo "  1) Codex (agent-duel/codex)$codex_marker"
echo "  2) Claude (agent-duel/claude)$claude_marker"
echo "  q) Quit without switching"

echo
printf "Enter choice [1/2/q]: "
while read -r -t 0 -n 1 _; do :; done
read -r choice
case "$choice" in
  1|c|C|codex|CODEX) winner_branch="agent-duel/codex" ;;
  2|l|L|claude|CLAUDE) winner_branch="agent-duel/claude" ;;
  q|Q) echo "Cancelled."; close_session; exit 0 ;;
  *) echo "Invalid choice."; exit 1 ;;
esac

if ! git -C "$REPO_ROOT" show-ref --verify --quiet "refs/heads/$winner_branch"; then
  echo "Error: branch not found: $winner_branch" >&2
  exit 1
fi

winner_dir="$CODEX_DIR"
loser_dir="$CLAUDE_DIR"
if [[ "$winner_branch" == "agent-duel/claude" ]]; then
  winner_dir="$CLAUDE_DIR"
  loser_dir="$CODEX_DIR"
fi

if [[ -d "$loser_dir" ]]; then
  git -C "$REPO_ROOT" worktree remove --force "$loser_dir" >/dev/null 2>&1 || true
fi
if [[ -d "$winner_dir" ]]; then
  if ! git -C "$REPO_ROOT" worktree remove --force "$winner_dir"; then
    echo "Error: failed to remove winner worktree at $winner_dir." >&2
    exit 1
  fi
fi

git -C "$REPO_ROOT" switch "$winner_branch"

printf '%s\n' "$winner_branch" > "$selected_file"

echo "Switched to $winner_branch in $REPO_ROOT"
git -C "$REPO_ROOT" --no-pager log -1 --stat
if command -v tmux >/dev/null 2>&1; then
  if tmux has-session -t "$SESSION_NAME" 2>/dev/null; then
    echo "Closing tmux session $SESSION_NAME..."
    tmux kill-session -t "$SESSION_NAME"
  fi
fi
