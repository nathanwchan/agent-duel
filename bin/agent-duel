#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
# shellcheck source=agent-duel-lib
source "$SCRIPT_DIR/agent-duel-lib"

usage() {
  cat <<'USAGE'
Usage: agent-duel -m "feature description" [-n name] [--reuse]
       agent-duel -f /path/to/prompt.txt [-n name] [--reuse]
       agent-duel "feature description" [-n name] [--reuse]

Starts parallel Codex/Claude implementations in tmux using git worktrees
under /tmp, then runs self-comparative reviews when both are done.

Options:
  -m, --message  Feature description (short)
  -f, --file     Feature description file (preferred for long prompts)
  -n, --name     Session name suffix (default: feature-YYYYmmdd-HHMMSS)
  --reuse        Reuse existing feat/codex and feat/claude branches
  --no-reset     Do not reset feat/codex and feat/claude to base branch
  -h, --help     Show help
USAGE
}

feature_name=""
prompt_file=""
prompt_message=""
reuse=false
reset_branches=true
positional=()

while [[ $# -gt 0 ]]; do
  case "$1" in
    -n|--name)
      feature_name="$2"
      shift 2
      ;;
    -f|--file)
      prompt_file="$2"
      shift 2
      ;;
    -m|--message)
      prompt_message="$2"
      shift 2
      ;;
    --reuse)
      reuse=true
      shift
      ;;
    --no-reset)
      reset_branches=false
      shift
      ;;
    -h|--help)
      usage
      exit 0
      ;;
    *)
      positional+=("$1")
      shift
      ;;
  esac
done

if [[ -n "$prompt_file" && -n "$prompt_message" ]]; then
  echo "Error: use only one of -m or -f." >&2
  exit 1
fi
if [[ -n "$prompt_file" && ! -f "$prompt_file" ]]; then
  echo "Error: prompt file not found: $prompt_file" >&2
  exit 1
fi
if [[ -n "$prompt_message" && ${#positional[@]} -gt 0 ]]; then
  echo "Error: provide a feature description once (use -m or a positional argument)." >&2
  exit 1
fi
if [[ -z "$prompt_file" && -z "$prompt_message" && ${#positional[@]} -gt 0 ]]; then
  prompt_message="${positional[*]}"
fi
if [[ -z "$prompt_file" && -z "$prompt_message" ]]; then
  read -r -p "Feature description: " prompt_message
fi
if [[ -z "$prompt_file" && -z "$prompt_message" ]]; then
  echo "Error: missing feature description. Use -m, -f, or a positional argument." >&2
  exit 1
fi

for cmd in git tmux codex claude; do
  if ! command -v "$cmd" >/dev/null 2>&1; then
    echo "Error: required command not found: $cmd" >&2
    exit 1
  fi
done

repo_root=$(git rev-parse --show-toplevel 2>/dev/null) || {
  echo "Error: not inside a git repo." >&2
  exit 1
}

base_branch=""
if git -C "$repo_root" show-ref --verify --quiet "refs/heads/main"; then
  base_branch="main"
elif git -C "$repo_root" show-ref --verify --quiet "refs/heads/master"; then
  base_branch="master"
else
  echo "Error: base branch 'main' or 'master' not found locally." >&2
  exit 1
fi

find_worktree_for_branch() {
  local branch="$1"
  git -C "$repo_root" worktree list --porcelain | awk -v target="refs/heads/$branch" '
    $1=="worktree" {path=$2}
    $1=="branch" && $2==target {print path}
  '
}

cleanup_tmp_worktree() {
  local branch="$1"
  local existing_path
  existing_path=$(find_worktree_for_branch "$branch" || true)
  if [[ -z "$existing_path" ]]; then
    return 0
  fi
  if [[ "$existing_path" == /tmp/agent-duel/* || "$existing_path" == /private/tmp/agent-duel/* ]]; then
    if [[ ! -f "$existing_path/.git" ]]; then
      rm -rf "$existing_path"
      git -C "$repo_root" worktree prune
      return 0
    fi
    if ! git -C "$repo_root" worktree remove "$existing_path"; then
      git -C "$repo_root" worktree remove --force "$existing_path"
    fi
  else
    echo "Error: branch $branch is already used by worktree at '$existing_path'." >&2
    echo "Refusing to remove a non-/tmp worktree." >&2
    echo "Please switch that worktree back to $base_branch (or another branch), then retry." >&2
    exit 1
  fi
}

repo_name=$(basename "$repo_root")
timestamp=$(date +%Y%m%d-%H%M%S)
if [[ -z "$feature_name" ]]; then
  feature_name="feature-$timestamp"
fi

session_dir="/tmp/agent-duel/$repo_name/$feature_name"
codex_dir="$session_dir/codex"
claude_dir="$session_dir/claude"

if [[ -e "$session_dir" ]]; then
  echo "Error: session directory exists: $session_dir" >&2
  exit 1
fi

# Restrict permissions so session files are only readable by owner
umask 077
mkdir -p "$session_dir"

feature_file="$session_dir/feature.txt"
if [[ -n "$prompt_file" ]]; then
  cp "$prompt_file" "$feature_file"
else
  printf '%s\n' "$prompt_message" > "$feature_file"
fi

codex_commit_message_file="$session_dir/codex.commit.txt"
claude_commit_message_file="$session_dir/claude.commit.txt"

codex_done="$session_dir/codex.done"
claude_done="$session_dir/claude.done"
codex_review="$session_dir/codex.review.txt"
claude_review="$session_dir/claude.review.txt"
summary_file="$session_dir/summary.md"
consensus_file="$session_dir/consensus.txt"
codex_prompt="$session_dir/codex.prompt.txt"
claude_prompt="$session_dir/claude.prompt.txt"
codex_review_prompt="$session_dir/codex.review.prompt.txt"
claude_review_prompt="$session_dir/claude.review.prompt.txt"
startup_delay="${AGENT_DUEL_STARTUP_DELAY:-1}"
claude_permission_mode="${AGENT_DUEL_CLAUDE_PERMISSION_MODE:-bypassPermissions}"
claude_add_dir="${AGENT_DUEL_CLAUDE_ADD_DIR:-$session_dir}"
claude_prompt_delay="${AGENT_DUEL_CLAUDE_PROMPT_DELAY:-2}"
claude_enter_delay="${AGENT_DUEL_CLAUDE_ENTER_DELAY:-0.2}"
codex_approval_policy="${AGENT_DUEL_CODEX_APPROVAL_POLICY:-never}"
codex_sandbox_mode="${AGENT_DUEL_CODEX_SANDBOX:-workspace-write}"

cleanup_tmp_worktree "feat/codex"
cleanup_tmp_worktree "feat/claude"

if ! $reuse; then
  existing_branches=()
  for branch in feat/codex feat/claude; do
    if git -C "$repo_root" show-ref --verify --quiet "refs/heads/$branch"; then
      existing_branches+=("$branch")
    fi
  done
  if ((${#existing_branches[@]})); then
    reuse=true
    echo "Reusing existing branches: ${existing_branches[*]}"
  fi
fi

if $reset_branches; then
  for branch in feat/codex feat/claude; do
    if git -C "$repo_root" show-ref --verify --quiet "refs/heads/$branch"; then
      git -C "$repo_root" branch -f "$branch" "$base_branch"
    fi
  done
fi

add_worktree() {
  local branch="$1"
  local dir="$2"
  if $reuse && git -C "$repo_root" show-ref --verify --quiet "refs/heads/$branch"; then
    git -C "$repo_root" worktree add "$dir" "$branch"
  else
    git -C "$repo_root" worktree add -b "$branch" "$dir" "$base_branch"
  fi
}

add_worktree "feat/codex" "$codex_dir"
add_worktree "feat/claude" "$claude_dir"

{
  echo "You are Codex working in this worktree on branch feat/codex."
  echo "Implement the feature described below."
  echo
  echo "Feature:"
  cat "$feature_file"
  echo
  echo "Constraints:"
  echo "- Work only in this worktree."
  echo "- Do not run tests unless explicitly asked."
  echo "- Before marking done, write a concise git commit message to:"
  echo "  $codex_commit_message_file"
  echo "- When complete, run:"
  echo "  touch \"$codex_done\""
  echo "- Then exit."
} > "$codex_prompt"

{
  echo "You are Claude working in this worktree on branch feat/claude."
  echo "Implement the feature described below."
  echo
  echo "Feature:"
  cat "$feature_file"
  echo
  echo "Constraints:"
  echo "- Work only in this worktree."
  echo "- Do not run tests unless explicitly asked."
  echo "- Before marking done, write a concise git commit message to:"
  echo "  $claude_commit_message_file"
  echo "- When complete, run:"
  echo "  touch \"$claude_done\""
  echo "- Then exit."
} > "$claude_prompt"

{
  echo "You are Codex. Compare the current worktree contents for feat/codex vs feat/claude and decide which is best."
  echo "Do not run tests unless explicitly asked."
  echo
  echo "Compare worktree diffs (not just branch refs). Suggested commands:"
  echo "  git -C \"$codex_dir\" status -sb"
  echo "  git -C \"$codex_dir\" diff \"$base_branch\""
  echo "  git -C \"$claude_dir\" status -sb"
  echo "  git -C \"$claude_dir\" diff \"$base_branch\""
  echo
  echo "Provide:"
  echo "- Winner (feat/codex or feat/claude)"
  echo "- Tradeoffs and rationale"
  echo "- Risks or regressions"
  echo "- Recommendation"
  echo
  echo "Format your response in Markdown with clear headings and bullet points."
  echo "Make the winner extremely easy to spot (bold, large heading, and a one-line TL;DR at the top)."
  echo "First line must be: \"Winner: feat/codex\" or \"Winner: feat/claude\"."
  echo "Save the review to:"
  echo "  $codex_review"
  echo "Then exit."
} > "$codex_review_prompt"

{
  echo "You are Claude. Compare the current worktree contents for feat/claude vs feat/codex and decide which is best."
  echo "Do not run tests unless explicitly asked."
  echo
  echo "Compare worktree diffs (not just branch refs). Suggested commands:"
  echo "  git -C \"$claude_dir\" status -sb"
  echo "  git -C \"$claude_dir\" diff \"$base_branch\""
  echo "  git -C \"$codex_dir\" status -sb"
  echo "  git -C \"$codex_dir\" diff \"$base_branch\""
  echo
  echo "Provide:"
  echo "- Winner (feat/claude or feat/codex)"
  echo "- Tradeoffs and rationale"
  echo "- Risks or regressions"
  echo "- Recommendation"
  echo
  echo "Format your response in Markdown with clear headings and bullet points."
  echo "Make the winner extremely easy to spot (bold, large heading, and a one-line TL;DR at the top)."
  echo "First line must be: \"Winner: feat/codex\" or \"Winner: feat/claude\"."
  echo "Save the review to:"
  echo "  $claude_review"
  echo "Then exit."
} > "$claude_review_prompt"

codex_prompt_escaped=$(printf '%q' "$(cat "$codex_prompt")")
claude_prompt_escaped=$(printf '%q' "$(cat "$claude_prompt")")
codex_review_prompt_escaped=$(printf '%q' "$(cat "$codex_review_prompt")")
claude_review_prompt_escaped=$(printf '%q' "$(cat "$claude_review_prompt")")
summary_file_escaped=$(printf '%q' "$summary_file")
session_dir_escaped=$(printf '%q' "$session_dir")
codex_review_escaped=$(printf '%q' "$codex_review")
claude_review_escaped=$(printf '%q' "$claude_review")
claude_add_dir_escaped=$(printf '%q' "$claude_add_dir")

session_name=$(printf 'agent-duel-%s-%s' "$repo_name" "$feature_name" | tr -cs 'A-Za-z0-9_.-' '_')
if tmux has-session -t "$session_name" 2>/dev/null; then
  echo "Error: tmux session already exists: $session_name" >&2
  exit 1
fi

cat > "$session_dir/session.env" <<SESSION_ENV
SESSION_NAME=$session_name
REPO_ROOT=$repo_root
BASE_BRANCH=$base_branch
CODEX_COMMIT_MESSAGE_FILE=$codex_commit_message_file
CLAUDE_COMMIT_MESSAGE_FILE=$claude_commit_message_file
CONSENSUS_FILE=$consensus_file
CODEX_DIR=$codex_dir
CLAUDE_DIR=$claude_dir
CODEX_REVIEW=$codex_review
CLAUDE_REVIEW=$claude_review
SESSION_ENV

tmux new-session -d -s "$session_name" -n impl -c "$codex_dir"
tmux split-window -h -t "$session_name":impl -c "$claude_dir"
tmux set-option -t "$session_name" status-right "Abort: Ctrl+b :kill-session"

sleep "$startup_delay"

tmux send-keys -t "$session_name":impl.0 "codex -a $codex_approval_policy -s $codex_sandbox_mode $codex_prompt_escaped" Enter
tmux send-keys -t "$session_name":impl.1 "claude --permission-mode $claude_permission_mode --add-dir $claude_add_dir_escaped" Enter

sleep "$claude_prompt_delay"
tmux load-buffer -b claude_impl_prompt "$claude_prompt"
tmux paste-buffer -b claude_impl_prompt -t "$session_name":impl.1
sleep "$claude_enter_delay"
tmux send-keys -t "$session_name":impl.1 C-m

(
  while [[ ! -f "$codex_done" || ! -f "$claude_done" ]]; do
    sleep 2
  done

  tmux new-window -t "$session_name" -n review -c "$codex_dir"
  codex_pane=$(tmux display -p -t "$session_name":review "#{pane_id}")
  bottom_pane=$(tmux split-window -v -p 21 -t "$session_name":review -c "$session_dir" -P -F "#{pane_id}")
  claude_pane=$(tmux split-window -h -t "$codex_pane" -c "$claude_dir" -P -F "#{pane_id}")
  sleep "$startup_delay"

  tmux send-keys -t "$codex_pane" "codex -a $codex_approval_policy -s $codex_sandbox_mode $codex_review_prompt_escaped" Enter
  tmux send-keys -t "$claude_pane" "claude --permission-mode $claude_permission_mode --add-dir $claude_add_dir_escaped" Enter

  sleep "$claude_prompt_delay"
  tmux load-buffer -b claude_review_prompt "$claude_review_prompt"
  tmux paste-buffer -b claude_review_prompt -t "$claude_pane"
  sleep "$claude_enter_delay"
  tmux send-keys -t "$claude_pane" C-m

  while [[ ! -f "$codex_review" || ! -f "$claude_review" ]]; do
    sleep 2
  done

  {
    echo "# Agent Duel Summary"
    echo
    echo "## Codex decision (feat/codex vs feat/claude)"
    echo
    cat "$codex_review"
    echo
    echo "---"
    echo
    echo "## Claude decision (feat/claude vs feat/codex)"
    echo
    cat "$claude_review"
  } > "$summary_file"

  codex_winner=$(detect_winner "$codex_review")
  claude_winner=$(detect_winner "$claude_review")
  consensus=""
  if [[ -n "$codex_winner" && "$codex_winner" == "$claude_winner" ]]; then
    consensus="$codex_winner"
  fi
  printf '%s\n' "$consensus" > "$consensus_file"

  tmux send-keys -t "$codex_pane" "bash -lc \"clear; agent-duel-render-review Codex $codex_review_escaped\"" Enter
  tmux send-keys -t "$claude_pane" "bash -lc \"clear; agent-duel-render-review Claude $claude_review_escaped\"" Enter
  tmux send-keys -t "$bottom_pane" "bash -lc \"agent-duel-select --no-summary $session_dir_escaped\"" Enter
  tmux select-pane -t "$bottom_pane"
) >/dev/null 2>&1 &

echo "Session: $session_name"
echo "Session dir: $session_dir"
echo "Reviews will be saved to:"
echo "  $codex_review"
echo "  $claude_review"
echo "Attach with: tmux attach -t $session_name"

tmux attach -t "$session_name"

selected_file="$session_dir/selected.txt"
if [[ -f "$selected_file" ]]; then
  winner_branch=$(cat "$selected_file")
  echo "Winner selected: $winner_branch"
  echo "Repo now on branch: $winner_branch"
  git -C "$repo_root" --no-pager log -1 --stat
fi
