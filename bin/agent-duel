#!/usr/bin/env bash
set -euo pipefail

usage() {
  cat <<'USAGE'
Usage: agent-duel -m "feature description" [-n name] [--reuse]
       agent-duel -f /path/to/prompt.txt [-n name] [--reuse]

Starts parallel Codex/Claude implementations in tmux using git worktrees
under /tmp, then runs self-comparative reviews when both are done.

Options:
  -m, --message  Feature description (short)
  -f, --file     Feature description file (preferred for long prompts)
  -n, --name     Session name suffix (default: feature-YYYYmmdd-HHMMSS)
  --reuse        Reuse existing feat/codex and feat/claude branches
  -h, --help     Show help
USAGE
}

feature_name=""
prompt_file=""
prompt_message=""
reuse=false

while [[ $# -gt 0 ]]; do
  case "$1" in
    -n|--name)
      feature_name="$2"
      shift 2
      ;;
    -f|--file)
      prompt_file="$2"
      shift 2
      ;;
    -m|--message)
      prompt_message="$2"
      shift 2
      ;;
    --reuse)
      reuse=true
      shift
      ;;
    -h|--help)
      usage
      exit 0
      ;;
    *)
      echo "Unknown argument: $1" >&2
      usage
      exit 1
      ;;
  esac
done

if [[ -n "$prompt_file" && -n "$prompt_message" ]]; then
  echo "Error: use only one of -m or -f." >&2
  exit 1
fi
if [[ -z "$prompt_file" && -z "$prompt_message" ]]; then
  echo "Error: missing feature description. Use -m or -f." >&2
  exit 1
fi
if [[ -n "$prompt_file" && ! -f "$prompt_file" ]]; then
  echo "Error: prompt file not found: $prompt_file" >&2
  exit 1
fi

for cmd in git tmux codex claude; do
  if ! command -v "$cmd" >/dev/null 2>&1; then
    echo "Error: required command not found: $cmd" >&2
    exit 1
  fi
done

repo_root=$(git rev-parse --show-toplevel 2>/dev/null) || {
  echo "Error: not inside a git repo." >&2
  exit 1
}

base_branch=""
if git -C "$repo_root" show-ref --verify --quiet "refs/heads/main"; then
  base_branch="main"
elif git -C "$repo_root" show-ref --verify --quiet "refs/heads/master"; then
  base_branch="master"
else
  echo "Error: base branch 'main' or 'master' not found locally." >&2
  exit 1
fi

find_worktree_for_branch() {
  local branch="$1"
  git -C "$repo_root" worktree list --porcelain | awk -v target="refs/heads/$branch" '
    $1=="worktree" {path=$2}
    $1=="branch" && $2==target {print path}
  '
}

cleanup_tmp_worktree() {
  local branch="$1"
  local existing_path
  existing_path=$(find_worktree_for_branch "$branch" || true)
  if [[ -z "$existing_path" ]]; then
    return 0
  fi
  if [[ "$existing_path" == /tmp/agent-duel/* || "$existing_path" == /private/tmp/agent-duel/* ]]; then
    if [[ ! -f "$existing_path/.git" ]]; then
      rm -rf "$existing_path"
      git -C "$repo_root" worktree prune
      return 0
    fi
    if ! git -C "$repo_root" worktree remove "$existing_path"; then
      git -C "$repo_root" worktree remove --force "$existing_path"
    fi
  else
    echo "Error: branch $branch is already used by worktree at '$existing_path'." >&2
    echo "Refusing to remove a non-/tmp worktree." >&2
    exit 1
  fi
}

repo_name=$(basename "$repo_root")
timestamp=$(date +%Y%m%d-%H%M%S)
if [[ -z "$feature_name" ]]; then
  feature_name="feature-$timestamp"
fi

session_dir="/tmp/agent-duel/$repo_name/$feature_name"
codex_dir="$session_dir/codex"
claude_dir="$session_dir/claude"

if [[ -e "$session_dir" ]]; then
  echo "Error: session directory exists: $session_dir" >&2
  exit 1
fi

mkdir -p "$session_dir"

feature_file="$session_dir/feature.txt"
if [[ -n "$prompt_file" ]]; then
  cp "$prompt_file" "$feature_file"
else
  printf '%s\n' "$prompt_message" > "$feature_file"
fi

codex_done="$session_dir/codex.done"
claude_done="$session_dir/claude.done"
codex_review="$session_dir/codex.review.txt"
claude_review="$session_dir/claude.review.txt"
summary_file="$session_dir/summary.md"
codex_prompt="$session_dir/codex.prompt.txt"
claude_prompt="$session_dir/claude.prompt.txt"
codex_review_prompt="$session_dir/codex.review.prompt.txt"
claude_review_prompt="$session_dir/claude.review.prompt.txt"
startup_delay="${AGENT_DUEL_STARTUP_DELAY:-1}"
claude_permission_mode="${AGENT_DUEL_CLAUDE_PERMISSION_MODE:-bypassPermissions}"
claude_add_dir="${AGENT_DUEL_CLAUDE_ADD_DIR:-$session_dir}"
claude_prompt_delay="${AGENT_DUEL_CLAUDE_PROMPT_DELAY:-2}"
codex_approval_policy="${AGENT_DUEL_CODEX_APPROVAL_POLICY:-never}"
codex_sandbox_mode="${AGENT_DUEL_CODEX_SANDBOX:-workspace-write}"

cleanup_tmp_worktree "feat/codex"
cleanup_tmp_worktree "feat/claude"

if ! $reuse; then
  for branch in feat/codex feat/claude; do
    if git -C "$repo_root" show-ref --verify --quiet "refs/heads/$branch"; then
      echo "Error: branch $branch already exists. Delete it or run with --reuse." >&2
      exit 1
    fi
  done
fi

add_worktree() {
  local branch="$1"
  local dir="$2"
  if $reuse && git -C "$repo_root" show-ref --verify --quiet "refs/heads/$branch"; then
    git -C "$repo_root" worktree add "$dir" "$branch"
  else
    git -C "$repo_root" worktree add -b "$branch" "$dir" "$base_branch"
  fi
}

add_worktree "feat/codex" "$codex_dir"
add_worktree "feat/claude" "$claude_dir"

cat > "$codex_prompt" <<CODEX_PROMPT
You are Codex working in this worktree on branch feat/codex.
Implement the feature described below.

Feature:
$(cat "$feature_file")

Constraints:
- Work only in this worktree.
- Do not run tests unless explicitly asked.
- Before marking done, commit your changes (if any):
  git add -A
  git commit -m "agent-duel: codex implementation"
- When complete, run:
  touch "$codex_done"
- Then exit.
CODEX_PROMPT

cat > "$claude_prompt" <<CLAUDE_PROMPT
You are Claude working in this worktree on branch feat/claude.
Implement the feature described below.

Feature:
$(cat "$feature_file")

Constraints:
- Work only in this worktree.
- Do not run tests unless explicitly asked.
- Before marking done, commit your changes (if any):
  git add -A
  git commit -m "agent-duel: claude implementation"
- When complete, run:
  touch "$claude_done"
- Then exit.
CLAUDE_PROMPT

cat > "$codex_review_prompt" <<CODEX_REVIEW_PROMPT
You are Codex. Compare the current worktree contents for feat/codex vs feat/claude and decide which is best.
Do not run tests unless explicitly asked.

Compare worktree diffs (not just branch refs). Suggested commands:
  git -C "$codex_dir" status -sb
  git -C "$codex_dir" diff "$base_branch"
  git -C "$claude_dir" status -sb
  git -C "$claude_dir" diff "$base_branch"

Provide:
- Winner (feat/codex or feat/claude)
- Tradeoffs and rationale
- Risks or regressions
- Recommendation

Format your response in Markdown with clear headings and bullet points.
Save the review to:
  $codex_review
Then exit.
CODEX_REVIEW_PROMPT

cat > "$claude_review_prompt" <<CLAUDE_REVIEW_PROMPT
You are Claude. Compare the current worktree contents for feat/claude vs feat/codex and decide which is best.
Do not run tests unless explicitly asked.

Compare worktree diffs (not just branch refs). Suggested commands:
  git -C "$claude_dir" status -sb
  git -C "$claude_dir" diff "$base_branch"
  git -C "$codex_dir" status -sb
  git -C "$codex_dir" diff "$base_branch"

Provide:
- Winner (feat/claude or feat/codex)
- Tradeoffs and rationale
- Risks or regressions
- Recommendation

Format your response in Markdown with clear headings and bullet points.
Save the review to:
  $claude_review
Then exit.
CLAUDE_REVIEW_PROMPT

codex_prompt_escaped=$(printf '%q' "$(cat "$codex_prompt")")
codex_review_prompt_escaped=$(printf '%q' "$(cat "$codex_review_prompt")")
summary_file_escaped=$(printf '%q' "$summary_file")
session_dir_escaped=$(printf '%q' "$session_dir")
codex_review_escaped=$(printf '%q' "$codex_review")
claude_review_escaped=$(printf '%q' "$claude_review")
claude_add_dir_escaped=$(printf '%q' "$claude_add_dir")

session_name=$(printf 'agent-duel-%s-%s' "$repo_name" "$feature_name" | tr -cs 'A-Za-z0-9_.-' '_')
if tmux has-session -t "$session_name" 2>/dev/null; then
  echo "Error: tmux session already exists: $session_name" >&2
  exit 1
fi

cat > "$session_dir/session.env" <<SESSION_ENV
SESSION_NAME=$session_name
REPO_ROOT=$repo_root
BASE_BRANCH=$base_branch
CODEX_DIR=$codex_dir
CLAUDE_DIR=$claude_dir
CODEX_REVIEW=$codex_review
CLAUDE_REVIEW=$claude_review
SESSION_ENV

tmux new-session -d -s "$session_name" -n impl -c "$codex_dir"
tmux split-window -h -t "$session_name":impl -c "$claude_dir"

sleep "$startup_delay"

tmux send-keys -t "$session_name":impl.0 "codex -a $codex_approval_policy -s $codex_sandbox_mode $codex_prompt_escaped" Enter
tmux send-keys -t "$session_name":impl.1 "claude --permission-mode $claude_permission_mode --add-dir $claude_add_dir_escaped" Enter

sleep "$claude_prompt_delay"
tmux load-buffer -b claude_impl_prompt "$claude_prompt"
tmux paste-buffer -b claude_impl_prompt -t "$session_name":impl.1
tmux send-keys -t "$session_name":impl.1 Enter

(
  while [[ ! -f "$codex_done" || ! -f "$claude_done" ]]; do
    sleep 2
  done

  tmux new-window -t "$session_name" -n review -c "$codex_dir"
  tmux split-window -v -p 30 -t "$session_name":review -c "$session_dir"
  tmux split-window -h -t "$session_name":review.0 -c "$claude_dir"
  sleep "$startup_delay"

  tmux send-keys -t "$session_name":review.0 "codex -a $codex_approval_policy -s $codex_sandbox_mode $codex_review_prompt_escaped" Enter
  tmux send-keys -t "$session_name":review.2 "claude --permission-mode $claude_permission_mode --add-dir $claude_add_dir_escaped" Enter

  sleep "$claude_prompt_delay"
  tmux load-buffer -b claude_review_prompt "$claude_review_prompt"
  tmux paste-buffer -b claude_review_prompt -t "$session_name":review.2
  tmux send-keys -t "$session_name":review.2 Enter

  while [[ ! -f "$codex_review" || ! -f "$claude_review" ]]; do
    sleep 2
  done

  {
    echo "# Agent Duel Summary"
    echo
    echo "## Codex decision (feat/codex vs feat/claude)"
    echo
    cat "$codex_review"
    echo
    echo "---"
    echo
    echo "## Claude decision (feat/claude vs feat/codex)"
    echo
    cat "$claude_review"
  } > "$summary_file"

  tmux send-keys -t "$session_name":review.0 "bash -lc \"clear; agent-duel-render-review Codex $codex_review_escaped\"" Enter
  tmux send-keys -t "$session_name":review.2 "bash -lc \"clear; agent-duel-render-review Claude $claude_review_escaped\"" Enter
  tmux send-keys -t "$session_name":review.1 "bash -lc \"agent-duel-select --no-summary $session_dir_escaped\"" Enter
) >/dev/null 2>&1 &

echo "Session: $session_name"
echo "Session dir: $session_dir"
echo "Reviews will be saved to:"
echo "  $codex_review"
echo "  $claude_review"
echo "Attach with: tmux attach -t $session_name"

tmux attach -t "$session_name"

selected_file="$session_dir/selected.txt"
if [[ -f "$selected_file" ]]; then
  winner_branch=$(cat "$selected_file")
  echo "Winner selected: $winner_branch"
  echo "Repo now on branch: $winner_branch"
fi
